generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum ConversationEstado {
  pendiente
  respondido
  en_proceso
  requiere_agente
  cerrado
}

enum MessageFrom {
  client
  bot
  agent
}

enum Rol {
  admin
  agente
  invitado
}

enum Plan {
  gratis
  pro
}

enum Estado {
  inactivo
  activo
  suspendido
}

// üß† Configuraci√≥n del negocio (asociado a empresa)
model BusinessConfig {
  id                   Int      @id @default(autoincrement())
  nombre               String   @db.VarChar(100)
  descripcion          String   @db.Text
  servicios            String   @db.Text
  faq                  String   @db.Text
  horarios             String   @db.Text
  escalarSiNoConfia    Boolean
  escalarPalabrasClave String   @db.Text
  escalarPorReintentos Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  empresaId Int
  empresa   Empresa @relation(fields: [empresaId], references: [id])
}

// üí¨ Conversaciones asociadas a empresa
model Conversation {
  id        Int                @id @default(autoincrement())
  phone     String
  nombre    String?
  estado    ConversationEstado @default(pendiente)
  mensajes  Message[]
  createdAt DateTime           @default(now())

  empresaId Int
  empresa   Empresa @relation(fields: [empresaId], references: [id])
}

// üí¨ Mensajes en una conversaci√≥n
model Message {
  id             Int         @id @default(autoincrement())
  conversationId Int
  from           MessageFrom
  contenido      String      @db.Text
  timestamp      DateTime    @default(now())

  Conversation Conversation @relation(fields: [conversationId], references: [id])
}

// üè¢ Empresa
model Empresa {
  id              Int              @id @default(autoincrement())
  nombre          String
  plan            Plan             @default(gratis)
  estado          Estado           @default(inactivo)
  usuarios        Usuario[]
  configuraciones BusinessConfig[]
  conversaciones  Conversation[]
  cuentaWhatsapp  WhatsappAccount?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

// üë§ Usuario
model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  rol       Rol
  empresaId Int
  empresa   Empresa  @relation(fields: [empresaId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// üì≤ Cuenta de WhatsApp vinculada v√≠a OAuth
model WhatsappAccount {
  id            Int      @id @default(autoincrement())
  phoneNumberId String   @unique
  accessToken   String
  empresaId     Int      @unique
  empresa       Empresa  @relation(fields: [empresaId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
